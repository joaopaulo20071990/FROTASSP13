<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Planilha de Veículos (Importar Excel)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: Arial, Helvetica, sans-serif; background: #f5f5f5; padding:40px; }
h2 { color: #009688;}
input[type="number"] { width: 70px; }
table { border-collapse: collapse; margin-top:15px; }
th, td { border: 1px solid #ccc; padding: 6px 12px; text-align: center; }
th { background: #009688; color: #fff; }
tfoot td { font-weight:bold; background: #e0f7fa; }
tfoot tr.percent td { background: #f4f8c8; }
label { font-weight:bold; }
button { padding: 8px 18px; background:#009688; color:#fff; border:none; border-radius:5px;
        margin-left:10px; cursor: pointer;}
</style>
</head>
<body>
  <h2>Calculadora de Porcentagem de Transportadoras<br><span style="font-size:15px">Importando Excel</span></h2>
  
  <label for="excelFile">Selecione o arquivo Excel (.xlsx): </label>
  <input type="file" id="excelFile" accept=".xlsx" />
  <button onclick="importarXLSX()">Importar</button>
  
  <div id="aviso" style="color:#c00; margin-top:10px;"></div>
  
  <div id="tabelaDiv"></div>

<script>
let modais = [
  "MeliOne Yellow Pool", 
  "MeliOne Van Frota Fixa", 
  "Van Frota Fixa - Equipe dupla",
  "Van Frota Fixa - Equipe Única", 
  "Yellow Pool Large Van – Equipe dupla",
  "VUC dedicado com ajudante", 
  "Rental Utilitário com Ajudante", 
  "Melione Rental Utilitário com Ajudante",
  "Van Frota Fixa Dedicado", 
  "Melione Van Média Elétrica", 
  "Van Média elétrica",
  "Melione Large Van Eletrica J750",
  "Van Elétrica JV",
  "Large Van Eletrica J750",
  "SPOT -Bulk - VUC equipe única Pool",
  "Utilitário SDD",
  "Van TKS 2025",
  "UTILITÁRIO SPOT"  // Modal incluso aqui
];
let transportadoras = [
  "ALC","ÚNICA","BLD","TORRES","KANGU","MURICI","OUTROS"
];

let campos = {}; // Para guardar a referência dos inputs (campos[modal][transportadora]=input)

function gerarTabela() {
  let html = `<table><thead><tr><th>Modal</th>`;
  transportadoras.forEach(t => html += `<th>${t}</th>`);
  html += `</tr></thead><tbody>`;
  campos = {};
  modais.forEach(m => {
    html += `<tr><td>${m}</td>`;
    campos[m] = {};
    transportadoras.forEach(t => {
      let id = 'inp_'+m.replace(/[^\w]/g,'')+'_'+t.replace(/[^\w]/g,'');
      html += `<td><input type="number" id="${id}" min="0" value="0" oninput="atualizaResumo()"></td>`;
      campos[m][t] = id;
    });
    html += `</tr>`;
  });
  html += `</tbody><tfoot>`;
  html += `<tr class="total"><td>Total por transp.</td>`;
  transportadoras.forEach((t,i) => html += `<td id="tot_${t}">0</td>`);
  html += `</tr><tr class="percent"><td>% do total</td>`;
  transportadoras.forEach((t,i) => html += `<td id="pct_${t}">0 %</td>`);
  html += `</tr></tfoot></table>`;
  html += `<p><b>Total geral do dia: <span id="totalDia">0</span></b></p>`;
  document.getElementById('tabelaDiv').innerHTML = html;
}
gerarTabela(); // Gera a primeira vez

function atualizaResumo() {
  let somaPorTransp = {};
  let totalDia = 0;
  transportadoras.forEach(t=>somaPorTransp[t]=0);
  modais.forEach(m => {
    transportadoras.forEach(t => {
      let id = campos[m][t];
      let val = Number(document.getElementById(id).value) || 0;
      somaPorTransp[t] += val;
    });
  });
  transportadoras.forEach(t=> totalDia += somaPorTransp[t]);
  transportadoras.forEach(t => {
    document.getElementById(`tot_${t}`).innerText = somaPorTransp[t];
    document.getElementById(`pct_${t}`).innerText = totalDia ? ((somaPorTransp[t]*100/totalDia).toFixed(2) +' %') : '0 %';
  });
  document.getElementById('totalDia').innerText = totalDia;
}

function importarXLSX() {
  let input = document.getElementById('excelFile');
  let avisoDiv = document.getElementById('aviso');
  avisoDiv.innerText = '';
  if(!input.files[0]) { avisoDiv.innerText = "Selecione um arquivo .xlsx antes de importar!"; return; }
  let reader = new FileReader();
  reader.onload = function(e) {
    let data = new Uint8Array(e.target.result);
    let workbook = XLSX.read(data, {type:'array'});
    let sheet = workbook.Sheets[workbook.SheetNames[0]];
    let arr = XLSX.utils.sheet_to_json(sheet, {header:1});
    let ok=0;
    for(let i=1;i<arr.length;i++) {
      let [modal, trans, qtd] = arr[i];
      if(!modal || !trans) continue;
      qtd = Number(qtd)||0;
      // Corrige nomes, ignora se não achar (evita erro de acento/letra diferente)
      let modalM = modais.find(m=>modal.toUpperCase().replace(/\W/g,'')===m.toUpperCase().replace(/\W/g,''));
      let transM = transportadoras.find(t=>trans.toUpperCase().replace(/\W/g,'')===t.toUpperCase().replace(/\W/g,''));
      if(modalM && transM) {
        let id = campos[modalM][transM];
        document.getElementById(id).value = qtd;
        ok++;
      }
    }
    avisoDiv.innerText = ok ? "Planilha importada!" : "Planilha não reconhecida. Confira os nomes!";
    atualizaResumo();
  };
  reader.readAsArrayBuffer(input.files[0]);
}

</script>
</body>
</html>