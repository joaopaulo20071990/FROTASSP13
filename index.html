<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Programação de Carros Importável</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 16px; }
    .bloco { background: #fff; border: 2px solid #aaa; border-radius: 5px; margin: 16px 0; padding: 14px 18px; max-width: 670px;}
    h2 { margin: 0 0 8px 0; color: #009688; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
    th, td { border: 1px solid #bbb; padding: 6px 8px; text-align: center; }
    th { background: #009688; color: #fff; }
    .linha-total td { font-weight:bold; background: #fffde7;}
    #totaisglobais {margin: 32px 0; background: #fff; display: inline-block; border:2px solid #aaa; padding: 18px 28px;}
    .footer { color: #aaa; margin-top: 20px; }
    .painel-flex { display: flex; flex-wrap: wrap; gap: 24px; }
    @media (max-width:900px) {
      .painel-flex { flex-direction: column;}
      .bloco {max-width:100%;}
      #totaisglobais {width:100%;}
    }
    .importbox {padding:10px;background:#fffbe5;border:1px solid #f7ba03;margin-bottom:18px;display:inline-block;}
  </style>
</head>
<body>
  <h1>Programação de Carros - CICLO</h1>
  <div class="importbox">
    <input type="file" id="arquivoExcel" accept=".xlsx">
    <button onclick="importarExcel()">Importar Excel e Atualizar Dados</button>
    <span id="importmsg" style="color:green;font-weight:bold;margin-left:16px;"></span>
  </div>
  <div class="painel-flex" id="painel"></div>
  <div id="painel-extra"></div>

  <div id="totaisglobais">
    <b>Total de veículos do dia: <span id="total-dia">0</span></b>
    <div style="margin-top:7px;">
      % por transportadora:<br>
      <span id="percentuais"></span>
    </div>
    <div style="margin-top:7px;">
      Total NEX do dia: <span id="nex_total">0</span>
    </div>
    <div style="margin-top:7px;">
      Total MELI EXTRA do dia: <span id="meli_extra_total">0</span>
    </div>
  </div>

<script>
const blocos = [
  {
    nome: 'ALC', modais: [
      "MeliOne Yellow Pool",
      "MeliOne Van Frota Fixa",
      "Van Frota Fixa - Equipe dupla",
      "Van Frota Fixa - Equipe Única",
      "Yellow Pool Large Van – Equipe dupla",
      "VUC dedicado com ajudante",
      "Rental Utilitário com Ajudante",
      "Melione Rental Utilitário com Ajudante",
      "Utilitários SPOT",
    ]
  },
  {
    nome: 'MURICI', modais: [
      "Van Frota Fixa - Equipe Única",
      "VUC dedicado com ajudante",
      "Van Frota Fixa Dedicado",
      "MeliOne Van Frota Fixa",
      "Melione Van Média Elétrica",
      "Van Média elétrica",
      "Rental Utilitário com Ajudante",
    ]
  },
  {
    nome: 'TORRES', modais: [
      "MeliOne Yellow Pool",
      "Melione Large Van Eletrica J750",
      "MeliOne Van Frota Fixa",
      "Yellow Pool Large Van – Equipe dupla",
      "VUC dedicado com ajudante",
      "Rental Utilitário com Ajudante",
      "Van Elétrica JV",
      "Large Van Eletrica J750"
    ]
  },
  {
    nome: 'KANGU', modais: [
      "Utilitários SPOT",
      "Utilitários SDD"
    ]
  },
  {
    nome: 'BLD', modais: [
      "Utilitários SPOT",
      "Van TKS 2025"
    ]
  },
  {
    nome: 'ÚNICA', modais: [
      "Utilitários SPOT",
      "SPOT -Bulk - VUC equipe única Pool"
    ]
  }
];

const meliExtraModais = [
  { id: "4hrs", label: "4HRS" },
  { id: "vucextra", label: "VUC Extra" },
  { id: "moto", label: "MOTO" }
];

const nexSiglas = [
  { cidade: "ASSIS", sigla: "BRNSP871" },
  { cidade: "TUPÃ", sigla: "BRNSP424" },
  { cidade: "LINS", sigla: "BRNSP113" },
  { cidade: "GARÇA", sigla: "BRNSP142" },
  { cidade: "LINS", sigla: "BRNSP589" },
  { cidade: "LINS", sigla: "BRNSP762" },
  { cidade: "PALMITAL", sigla: "BRNSP344" }
];

function gerarTabelaModal(bloco) {
  let t = `<div class="bloco"><h2>${bloco.nome}</h2><table>
    <tr>
      <th>Modal</th>
      <th>CICLO AM</th>
      <th>CICLO PM</th>
      <th>No Show</th>
      <th>Total</th>
    </tr>`;
  bloco.modais.forEach((modal,idx) => {
    const id = bloco.nome+'_'+idx;
    t += `<tr>
        <td>${modal}</td>
        <td><input type="number" min="0" value="0" id="am_${id}" onchange="calcTotais()"></td>
        <td><input type="number" min="0" value="0" id="pm_${id}" onchange="calcTotais()"></td>
        <td><input type="number" min="0" value="0" id="no_${id}" onchange="calcTotais()"></td>
        <td id="total_${id}">0</td>
      </tr>`;
  });
  t += `
    <tr class="linha-total">
      <td>TOTAL</td>
      <td id="blocototal_am_${bloco.nome}">0</td>
      <td id="blocototal_pm_${bloco.nome}">0</td>
      <td id="blocototal_no_${bloco.nome}">0</td>
      <td id="blocototal_geral_${bloco.nome}">0</td>
    </tr></table></div>`;
  return t;
}

function blocoMeliExtra() {
  let t = `<div class="bloco"><h2>Meli Extra</h2><table>
    <tr>
      <th>Modal</th>
      <th>CICLO AM</th>
      <th>CICLO PM</th>
      <th>TOTAL</th>
    </tr>`;
  meliExtraModais.forEach(item => {
    t += `<tr>
      <td>${item.label}</td>
      <td><input type="number" min="0" value="0" id="meliExtra_${item.id}_am" onchange="calcTotais()"></td>
      <td><input type="number" min="0" value="0" id="meliExtra_${item.id}_pm" onchange="calcTotais()"></td>
      <td id="meliExtra_${item.id}_total">0</td>
    </tr>`;
  });
  t += `
    <tr class="linha-total">
      <td>TOTAL</td>
      <td id="meliExtra_total_am">0</td>
      <td id="meliExtra_total_pm">0</td>
      <td id="meliExtra_total_geral">0</td>
    </tr>
  </table></div>`;
  return t;
}

function blocoNEX() {
  let t = `<div class="bloco"><h2>NEX</h2><table>
    <tr>
      <th>Cidade</th>
      <th>Sigla</th>
      <th>Total</th>
    </tr>`;
  nexSiglas.forEach((item) => {
    let id = item.sigla.toLowerCase();
    t += `<tr>
      <td>${item.cidade}</td>
      <td>${item.sigla}</td>
      <td><input type="number" min="0" value="0" id="nex_${id}" onchange="calcTotais()"></td>
    </tr>`;
  });
  t += `
    <tr class="linha-total">
      <td colspan="2"><b>TOTAL</b></td>
      <td id="nex_total_bloco">0</td>
    </tr>
  </table></div>`;
  return t;
}

document.getElementById('painel').innerHTML = blocos.map(gerarTabelaModal).join('');
document.getElementById('painel-extra').innerHTML = blocoMeliExtra() + blocoNEX();

function calcTotais() {
  let globaisPorTransp = {};
  let totalDia = 0;
  let tabelaPercent=[];

  blocos.forEach( bloco => {
    let bloco_am = 0, bloco_pm = 0, bloco_no = 0, bloco_geral = 0;
    bloco.modais.forEach((modal, idx) => {
      const id = bloco.nome+'_'+idx;
      const am = +document.getElementById('am_'+id).value || 0;
      const pm = +document.getElementById('pm_'+id).value || 0;
      const no = +document.getElementById('no_'+id).value || 0;
      const total = am + pm;
      bloco_am += am;
      bloco_pm += pm;
      bloco_no += no;
      bloco_geral += total;
      document.getElementById('total_'+id).innerText = total;
    });
    document.getElementById('blocototal_am_'+bloco.nome).innerText = bloco_am;
    document.getElementById('blocototal_pm_'+bloco.nome).innerText = bloco_pm;
    document.getElementById('blocototal_no_'+bloco.nome).innerText = bloco_no;
    document.getElementById('blocototal_geral_'+bloco.nome).innerText = bloco_geral;
    globaisPorTransp[bloco.nome]=bloco_geral;
    totalDia += bloco_geral;
  });

  document.getElementById('total-dia').innerText = totalDia;

  for(let transp in globaisPorTransp)
    tabelaPercent.push(
      `${transp}: <b>${totalDia ? (100*globaisPorTransp[transp]/totalDia).toFixed(1) : '0'} %</b>`
    );
  document.getElementById('percentuais').innerHTML = tabelaPercent.join(" &nbsp;|&nbsp; ");

  let meliExtra_am = 0, meliExtra_pm = 0, meliExtra_geral = 0;
  meliExtraModais.forEach(item => {
    let am = +document.getElementById('meliExtra_'+item.id+'_am').value || 0;
    let pm = +document.getElementById('meliExtra_'+item.id+'_pm').value || 0;
    let total = am + pm;
    meliExtra_am += am;
    meliExtra_pm += pm;
    meliExtra_geral += total;
    document.getElementById('meliExtra_'+item.id+'_total').innerText = total;
  });
  document.getElementById('meliExtra_total_am').innerText = meliExtra_am;
  document.getElementById('meliExtra_total_pm').innerText = meliExtra_pm;
  document.getElementById('meliExtra_total_geral').innerText = meliExtra_geral;
  document.getElementById('meli_extra_total').innerText = meliExtra_geral;

  let nex_total=0;
  nexSiglas.forEach(item=>{
    let id = item.sigla.toLowerCase();
    nex_total += +document.getElementById('nex_'+id).value || 0;
  });
  document.getElementById('nex_total_bloco').innerText = nex_total;
  document.getElementById('nex_total').innerText = nex_total;
}
window.onload = calcTotais;

// IMPORTAÇÃO DO EXCEL!
function importarExcel() {
  var arquivo = document.getElementById('arquivoExcel').files[0];
  if (!arquivo) {
    alert("Selecione um arquivo Excel (.xlsx)");
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    var data = new Uint8Array(e.target.result);
    var workbook = XLSX.read(data, {type: 'array'});
    var sheet = workbook.Sheets[workbook.SheetNames[0]];
    var arr = XLSX.utils.sheet_to_json(sheet, {header:1});
    preencherPaginaComExcel(arr);
  };
  reader.readAsArrayBuffer(arquivo);
}

function normalize(str) {
  return (str||"").toLowerCase().replace(/[\s\u2013-]+/g," ").replace(/\s+/g," ").replace(/[^\w ]/g,'').trim();
}

function preencherPaginaComExcel(arr) {
  let preencheu = false;
  // BLOCO ALC
  let alcStart = arr.findIndex(linha=>normalize(linha[0])=="melione yellow pool");
  if (alcStart >= 0) {
    for (let i=0; i<blocos[0].modais.length; i++) {
      let linha = arr[alcStart+i];
      if(!linha) continue;
      document.getElementById('am_ALC_'+i).value = Number(linha[1]) || 0;
      document.getElementById('pm_ALC_'+i).value = Number(linha[2]) || 0;
      document.getElementById('no_ALC_'+i).value = Number(linha[3]) || 0;
      preencheu = true;
    }
  }
  // BLOCO MURICI
  let muriciStart = arr.findIndex(linha=>normalize(linha[0])=="van frota fixa equipe unica");
  if (muriciStart >= 0) {
    for (let i=0; i<blocos[1].modais.length; i++) {
      let linha = arr[muriciStart+i];
      if(!linha) continue;
      document.getElementById('am_MURICI_'+i).value = Number(linha[1]) || 0;
      document.getElementById('pm_MURICI_'+i).value = Number(linha[2]) || 0;
      document.getElementById('no_MURICI_'+i).value = Number(linha[3]) || 0;
      preencheu = true;
    }
  }
  // BLOCO TORRES
  let torresStart = arr.findIndex(linha=>normalize(linha[0])=="melione yellow pool" && normalize((arr[arr.indexOf(linha)-1]||[])[0])=="torres ciclo am");
  if(torresStart>=0){
    for (let i=0; i<blocos[2].modais.length; i++) {
      let linha = arr[torresStart+i];
      if(!linha) continue;
      document.getElementById('am_TORRES_'+i).value = Number(linha[1]) || 0;
      document.getElementById('pm_TORRES_'+i).value = Number(linha[2]) || 0;
      document.getElementById('no_TORRES_'+i).value = Number(linha[3]) || 0;
      preencheu = true;
    }
  }
  // KANGU
  let kanguStart = arr.findIndex(linha=>normalize(linha[0])=="utilitarios spot");
  if(kanguStart>=0){
    for(let i=0; i<blocos[3].modais.length; i++){
      let linha = arr[kanguStart+i];
      if(!linha) continue;
      document.getElementById('am_KANGU_'+i).value = Number(linha[1]) || 0;
      document.getElementById('pm_KANGU_'+i).value = Number(linha[2]) || 0;
      document.getElementById('no_KANGU_'+i).value = Number(linha[3]) || 0;
      preencheu = true;
    }
  }
  // BLD
  let bldStart = arr.findIndex(linha=>normalize(linha[0])=="utilitarios spot" && normalize((arr[arr.indexOf(linha)-1]||[])[0])=="bld brasil ciclo am");
  if(bldStart>=0){
    for(let i=0; i<blocos[4].modais.length; i++){
      let linha = arr[bldStart+i];
      if(!linha) continue;
      document.getElementById('am_BLD_'+i).value = Number(linha[1]) || 0;
      document.getElementById('pm_BLD_'+i).value = Number(linha[2]) || 0;
      document.getElementById('no_BLD_'+i).value = Number(linha[3]) || 0;
      preencheu = true;
    }
  }
  // UNICA
  let unicaStart = arr.findIndex(linha=>normalize(linha[0])=="utilitarios spot" && normalize((arr[arr.indexOf(linha)-1]||[])[0])=="unica ciclo am");
  if(unicaStart>=0){
    for(let i=0; i<blocos[5].modais.length; i++){
      let linha = arr[unicaStart+i];
      if(!linha) continue;
      document.getElementById('am_ÚNICA_'+i).value = Number(linha[1]) || 0;
      document.getElementById('pm_ÚNICA_'+i).value = Number(linha[2]) || 0;
      document.getElementById('no_ÚNICA_'+i).value = Number(linha[3]) || 0;
      preencheu = true;
    }
  }
  // MELI EXTRA
  let meliExtraLin = arr.findIndex(linha=>normalize(linha[0])=="4hrs" && normalize((arr[arr.indexOf(linha)-1]||[])[0])=="meli extra");
  if (meliExtraLin < 0) meliExtraLin = arr.findIndex(linha=>normalize(linha[0])=="4hrs");
  if (meliExtraLin >= 0) {
    for(let i=0;i<meliExtraModais.length;i++){
      let linha = arr[meliExtraLin + i];
      if(!linha) continue;
      document.getElementById('meliExtra_'+meliExtraModais[i].id+'_am').value = Number(linha[1]) || 0;
      document.getElementById('meliExtra_'+meliExtraModais[i].id+'_pm').value = Number(linha[2]) || 0;
    }
    preencheu = true;
  }
  // NEX
  let nexLine = arr.findIndex(linha=>linha[0]&&normalize(linha[0])=="assis");
  if(nexLine>=0){
    for(let i=0;i<nexSiglas.length;i++){
      let linha = arr[nexLine+i];
      if(!linha) continue;
      document.getElementById('nex_'+nexSiglas[i].sigla.toLowerCase()).value = Number(linha[2]) || 0;
    }
    preencheu = true;
  }

  calcTotais();
  document.getElementById('importmsg').innerText = preencheu ? "Importação realizada!" : "Não foi possível localizar os dados na planilha!";
  setTimeout(()=>{document.getElementById('importmsg').innerText="";}, 5000);
}
</script>
<div class="footer">
  Pronto para uso! 
  <b>Ao importar um Excel no botão acima, os campos serão preenchidos automaticamente.</b>
</div>
</body>
</html>